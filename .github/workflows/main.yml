name: Parrot Desktop with VNC and Ngrok v3

on:
  workflow_dispatch:

jobs:
  parrot:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Start Parrot OS Container
        run: |
          docker pull parrotsec/core:latest
          docker run -dit --name parrot --privileged -p 5901:5901 parrotsec/core:latest bash

      - name: Install XFCE + VNC in Parrot
        run: |
          docker exec parrot apt update
          docker exec parrot apt install -y xfce4 xfce4-goodies tightvncserver wget curl dbus-x11 sudo

      - name: Setup VNC
        run: |
          docker exec -e USER=root parrot bash -c 'mkdir -p ~/.vnc && echo "123456" | vncpasswd -f > ~/.vnc/passwd && chmod 600 ~/.vnc/passwd'
          docker exec -e USER=root parrot bash -c 'echo "#!/bin/bash" > ~/.vnc/xstartup && echo "startxfce4 &" >> ~/.vnc/xstartup && chmod +x ~/.vnc/xstartup'
          docker exec -e USER=root parrot vncserver :1

      - name: Download and Start Ngrok v3 Binary (working)
        run: |
          curl -Lo ngrok https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64 || exit 1
          chmod +x ngrok
          ./ngrok config add-authtoken 2stzlWkZievCRtP4Wwp9PhP3J5F_6TnB7h37UqrikBqS3HWqv
          ./ngrok tcp 5901 > ngrok.log &
          sleep 10
          grep -o 'tcp://[0-9a-zA-Z\.:]*' ngrok.log || (echo "‚ùå Ngrok tunnel failed"; exit 1)
