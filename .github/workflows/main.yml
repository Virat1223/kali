name: Kali Desktop over VNC (Docker version)

on:
  workflow_dispatch:

jobs:
  kali:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Pull Kali Linux Docker image
        run: |
          docker pull kalilinux/kali-rolling

      - name: Start Kali with Desktop + VNC + Ngrok
        run: |
          docker run -dit --name kali \
            --privileged \
            -p 5901:5901 \
            kalilinux/kali-rolling bash

          docker exec kali apt update
          docker exec kali apt install -y xfce4 xfce4-goodies tightvncserver wget curl sudo dbus-x11

          docker exec kali bash -c 'echo "123456" | vncpasswd -f > ~/.vnc/passwd && chmod 600 ~/.vnc/passwd'
          docker exec kali bash -c 'echo "#!/bin/bash" > ~/.vnc/xstartup && echo "startxfce4 &" >> ~/.vnc/xstartup && chmod +x ~/.vnc/xstartup'
          docker exec kali vncserver :1

          wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
          unzip ngrok-stable-linux-amd64.zip
          chmod +x ngrok
          ./ngrok authtoken 2stzlWkZievCRtP4Wwp9PhP3J5F_6TnB7h37UqrikBqS3HWqv
          ./ngrok tcp 5901 &
          sleep 10
          curl -s localhost:4040/api/tunnels | grep -o 'tcp://[0-9a-zA-Z\.:]*'
