name: Kali Linux GUI via VNC + LocalXpose (no timeout, no CC)

on:
  workflow_dispatch:

jobs:
  kali:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Start Kali Container
        run: |
          docker pull kalilinux/kali-rolling
          docker run -dit --name kali --privileged kalilinux/kali-rolling bash

      - name: Install GUI, VNC, LocalXpose in Kali
        run: |
          docker exec kali apt update
          docker exec kali apt install -y xfce4 xfce4-goodies tightvncserver openssh-client curl dbus-x11

      - name: Setup VNC Server
        run: |
          docker exec kali mkdir -p /root/.vnc
          docker exec kali bash -c "echo '123456' | vncpasswd -f > /root/.vnc/passwd"
          docker exec kali chmod 600 /root/.vnc/passwd
          docker exec kali bash -c 'echo "#!/bin/bash\nstartxfce4 &" > /root/.vnc/xstartup'
          docker exec kali chmod +x /root/.vnc/xstartup
          docker exec -e USER=root kali vncserver :1

      - name: Install & Start LocalXpose Tunnel (TCP:5901)
        run: |
          curl -s https://api.localxpose.io/client/download/latest/linux-amd64 -o lx
          chmod +x lx
          ./lx auth DgN6KiykIQ1cb7XvcoaYz2AXX68yIwvUndjYfchQ
          ./lx tunnel tcp --port 5901 > lx.log &
          sleep 10
          echo "ðŸ”— LocalXpose Tunnel URL:"
          cat lx.log | grep -i 'tcp://'

      - name: Keep Runner Alive
        run: sleep 3500
