name: Kali GUI in Browser (XFCE + noVNC)

on:
  workflow_dispatch:

jobs:
  kali-novnc:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: ğŸ³ Pull and Run Kali Docker Container
        run: |
          docker pull iphoneintosh/kali-docker:latest
          docker run -d --name kali-gui \
            -p 6080:8080 -p 5900:5900 \
            -e VNCEXPOSE=0 \
            -e VNCPWD=changeme \
            iphoneintosh/kali-docker:latest
          sleep 8

      - name: ğŸŒ Create SSH Tunnel via localhost.run
        run: |
          nohup ssh -o StrictHostKeyChecking=no \
            -R 80:localhost:6080 nokey@localhost.run \
            > tunnel.log 2>&1 &
          sleep 10
          echo "ğŸ” Tunnel Log:"
          cat tunnel.log || true
          echo "ğŸŒ Access URL:"
          grep -oE '[a-z0-9\-]{36}\.localhost\.run' tunnel.log | head -n1

      - name: ğŸ•’ Keep Runner Alive
        run: sleep 3500
