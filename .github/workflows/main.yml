name: Kali Desktop with VNC (Serveo Tunnel from Inside Container)

on:
  workflow_dispatch:

jobs:
  kali:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Start Kali Container
        run: |
          docker pull kalilinux/kali-rolling
          docker run -dit --name kali --privileged -p 5901:5901 kalilinux/kali-rolling bash

      - name: Install GUI, VNC & SSH Inside Kali
        run: |
          docker exec kali apt update
          docker exec kali apt install -y xfce4 xfce4-goodies tightvncserver openssh-client dbus-x11 curl

      - name: Setup VNC
        run: |
          docker exec kali mkdir -p /root/.vnc
          docker exec kali bash -c "echo '123456' | vncpasswd -f > /root/.vnc/passwd"
          docker exec kali chmod 600 /root/.vnc/passwd
          docker exec kali bash -c 'echo "#!/bin/bash\nstartxfce4 &" > /root/.vnc/xstartup'
          docker exec kali chmod +x /root/.vnc/xstartup
          docker exec kali vncserver :1

      - name: Start Serveo Tunnel Inside Kali
        run: |
          docker exec -d kali bash -c "ssh -o StrictHostKeyChecking=no -R 5901:localhost:5901 serveo.net"
          sleep 10
          echo "ğŸŒ VNC is being tunneled through serveo.net:5901"
          echo "ğŸ”‘ VNC password: 123456"

      - name: Keep Job Alive for Connection
        run: sleep 3500
