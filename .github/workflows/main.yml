name: Kali Linux Desktop over VNC (Ngrok v3 Safe Download)

on:
  workflow_dispatch:

jobs:
  kali:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Pull Kali Docker Image
        run: |
          docker pull kalilinux/kali-rolling

      - name: Start Kali Container
        run: |
          docker run -dit --name kali --privileged -p 5901:5901 kalilinux/kali-rolling bash

      - name: Install XFCE Desktop + VNC inside Kali
        run: |
          docker exec kali apt update
          docker exec kali apt install -y xfce4 xfce4-goodies tightvncserver wget curl sudo dbus-x11

      - name: Setup VNC Password and Desktop
        run: |
          docker exec -e USER=root kali bash -c 'mkdir -p ~/.vnc && echo "123456" | vncpasswd -f > ~/.vnc/passwd && chmod 600 ~/.vnc/passwd'
          docker exec -e USER=root kali bash -c 'echo "#!/bin/bash" > ~/.vnc/xstartup && echo "startxfce4 &" >> ~/.vnc/xstartup && chmod +x ~/.vnc/xstartup'
          docker exec -e USER=root kali vncserver :1

      - name: Download and Start Ngrok (GitHub Mirror)
        run: |
          curl -Lo ngrok.zip https://github.com/ngrok/ngrok/releases/latest/download/ngrok-stable-linux-amd64.zip
          unzip ngrok.zip
          chmod +x ngrok
          ./ngrok config add-authtoken 2stzlWkZievCRtP4Wwp9PhP3J5F_6TnB7h37UqrikBqS3HWqv
          ./ngrok tcp 5901 > ngrok.log &
          sleep 10
          grep -o 'tcp://[0-9a-zA-Z\.:]*' ngrok.log || (echo "‚ùå Ngrok tunnel failed"; exit 1)
