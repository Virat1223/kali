name: Browser-Based Kali GUI (noVNC + Localhost.run)

on:
  workflow_dispatch:

jobs:
  kali-browser:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: 🐍 Start Kali Container
        run: |
          docker pull kalilinux/kali-rolling
          docker run -dit --name kali --privileged kalilinux/kali-rolling bash

      - name: ⚙️ Install XFCE, noVNC, websockify (with pip fix)
        run: |
          docker exec kali apt update
          docker exec kali apt install -y xfce4 xfce4-goodies tightvncserver curl git python3 python3-pip openssh-client
          docker exec kali bash -c "pip3 install --break-system-packages websockify"
          docker exec kali git clone https://github.com/novnc/noVNC /opt/novnc
          docker exec kali git clone https://github.com/novnc/websockify /opt/novnc/utils/websockify
          docker exec kali mkdir -p /root/.vnc
          docker exec kali bash -c "echo '123456' | vncpasswd -f > /root/.vnc/passwd"
          docker exec kali chmod 600 /root/.vnc/passwd
          docker exec kali bash -c "echo '#!/bin/bash\nstartxfce4 &' > /root/.vnc/xstartup"
          docker exec kali chmod +x /root/.vnc/xstartup
          docker exec -e USER=root kali vncserver :1

            - name: 🌍 Start noVNC and Tunnel (localhost.run)
              run: |
               docker exec -d kali bash -c "/opt/novnc/utils/novnc_proxy --vnc localhost:5901 --listen 6080"
               nohup ssh -o StrictHostKeyChecking=no -R 80:localhost:6080 nokey@localhost.run > tunnel.log 2>&1 &
               sleep 10
               echo "🔗 Checking tunnel output..."
               cat tunnel.log || true
               echo "🔗 Your Kali browser GUI might be here:"
               echo "👉 https://ee4b8f6e-c111-4580-832b-badf136d6ac8.localhost.run"

      - name: 🕒 Keep GitHub Runner Alive
        run: sleep 3500
