name: Kali Linux Desktop with VNC over Serveo (No CC, Fixed USER Bug)

on:
  workflow_dispatch:

jobs:
  kali:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Start Kali Linux Container
        run: |
          docker pull kalilinux/kali-rolling
          docker run -dit --name kali --privileged -p 5901:5901 kalilinux/kali-rolling bash

      - name: Install XFCE, VNC, SSH in Kali
        run: |
          docker exec kali apt update
          docker exec kali apt install -y xfce4 xfce4-goodies tightvncserver openssh-client curl dbus-x11

      - name: Setup VNC with Fixed USER
        run: |
          docker exec kali mkdir -p /root/.vnc
          docker exec kali bash -c "echo '123456' | vncpasswd -f > /root/.vnc/passwd"
          docker exec kali chmod 600 /root/.vnc/passwd
          docker exec kali bash -c 'echo "#!/bin/bash\nstartxfce4 &" > /root/.vnc/xstartup'
          docker exec kali chmod +x /root/.vnc/xstartup
          docker exec -e USER=root kali vncserver :1

      - name: Create Serveo Tunnel from Inside Kali
        run: |
          docker exec -d kali bash -c "ssh -o StrictHostKeyChecking=no -R 5901:localhost:5901 serveo.net"
          echo "ğŸŒ Serveo tunnel created."
          echo "ğŸ–¥ï¸  Connect VNC Viewer to: serveo.net:5901"
          echo "ğŸ”‘ VNC Password: 123456"
          sleep 20

      - name: Keep Job Alive for 58 Minutes
        run: sleep 3480
