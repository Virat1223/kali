name: Kali Linux GUI via VNC + LocalXpose (No Timeouts, No CC)

on:
  workflow_dispatch:

jobs:
  kali:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Start Kali Container
        run: |
          docker pull kalilinux/kali-rolling
          docker run -dit --name kali --privileged kalilinux/kali-rolling bash

      - name: Install GUI, VNC, and unzip in Kali
        run: |
          docker exec kali apt update
          docker exec kali apt install -y xfce4 xfce4-goodies tightvncserver dbus-x11 unzip curl

      - name: Configure VNC Server
        run: |
          docker exec kali mkdir -p /root/.vnc
          docker exec kali bash -c "echo '123456' | vncpasswd -f > /root/.vnc/passwd"
          docker exec kali chmod 600 /root/.vnc/passwd
          docker exec kali bash -c 'echo "#!/bin/bash\nstartxfce4 &" > /root/.vnc/xstartup'
          docker exec kali chmod +x /root/.vnc/xstartup
          docker exec -e USER=root kali vncserver :1

      - name: Download & Start LocalXpose Tunnel (TCP 5901)
        run: |
          curl -L https://github.com/localxpose/localxpose/releases/latest/download/localxpose-linux-amd64 -o localxpose
          chmod +x localxpose

          ./localxpose auth DgN6KiykIQ1cb7XvcoaYz2AXX68yIwvUndjYfchQ
          ./localxpose tunnel tcp --port 5901 > lx.log &
          sleep 10
          echo "ðŸ”— VNC Tunnel Ready:"
          cat lx.log | grep -i 'tcp://'

      - name: Keep Alive
        run: sleep 3500
