name: Kali Desktop over VNC

on:
  workflow_dispatch:

jobs:
  kali-vnc:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Clean system and prep
      run: |
        sudo rm -rf /var/lib/dpkg/lock
        sudo rm -rf /var/lib/apt/lists/lock
        sudo rm -rf /var/cache/apt/archives/lock
        sudo dpkg --configure -a
        sudo apt clean
        sudo apt update --fix-missing

    - name: Add Kali repo & key
      run: |
        echo "deb http://http.kali.org/kali kali-rolling main contrib non-free" | sudo tee /etc/apt/sources.list.d/kali.list
        curl -fsSL https://archive.kali.org/archive-key.asc | sudo apt-key add -
        sudo apt update

    - name: Install Kali Desktop and VNC server
      run: |
        sudo DEBIAN_FRONTEND=noninteractive apt install -y kali-linux-core xfce4 xfce4-goodies tightvncserver dbus-x11

    - name: Set up VNC server
      run: |
        mkdir -p ~/.vnc
        echo "123456" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd
        echo "#!/bin/bash" > ~/.vnc/xstartup
        echo "startxfce4 &" >> ~/.vnc/xstartup
        chmod +x ~/.vnc/xstartup
        vncserver :1

    - name: Download ngrok and start tunnel
      run: |
        wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
        unzip ngrok-stable-linux-amd64.zip
        chmod +x ngrok
        ./ngrok authtoken 2stzlWkZievCRtP4Wwp9PhP3J5F_6TnB7h37UqrikBqS3HWqv
        ./ngrok tcp 5901 &
        sleep 10
        curl -s localhost:4040/api/tunnels | grep -o 'tcp://[0-9a-zA-Z\.:]*'
